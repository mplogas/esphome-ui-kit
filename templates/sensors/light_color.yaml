# templates/sensors/light_color.yaml
# Reads the rgb_color attribute from a Home Assistant light
# Expected vars:
# - hass_entity_id: The HA light entity ID
# - id: The internal ID for this sensor

platform: homeassistant
entity_id: ${hass_entity_id}
id: ${id}_rgb
attribute: rgb_color
internal: true
on_value:
  - lambda: |-
      // Check if the light is actually on
      if (id(${id}_state).state != "on") return;

      lv_color_t color;
      lv_color_t bg_color;
      
      std::string rgb_str = x;
      int r, g, b;
      
      if (sscanf(rgb_str.c_str(), "(%d,%d,%d)", &r, &g, &b) == 3 || 
          sscanf(rgb_str.c_str(), "[%d,%d,%d]", &r, &g, &b) == 3 ||
          sscanf(rgb_str.c_str(), "%d,%d,%d", &r, &g, &b) == 3) {
          
          color = lv_color_make(r, g, b);
          bg_color = lv_color_make(r/5, g/5, b/5);
          
          // Update UI
          if (id(${widget_id}_icon) != nullptr) {
            lv_obj_set_style_text_color(id(${widget_id}_icon), color, LV_PART_MAIN);
          }
          if (id(${widget_id}) != nullptr) {
            lv_obj_set_style_bg_color(id(${widget_id}), bg_color, LV_PART_MAIN);
          }
          
          // Update Slider if this light is selected - Removed in favor of presets
          /*
          if (id(current_light_entity) == "${hass_entity_id}") {
             lv_color_hsv_t hsv = lv_color_to_hsv(color);
             if (id(slider_hue) != nullptr) {
                lv_slider_set_value(id(slider_hue), hsv.h, LV_ANIM_OFF);
             }
          }
          */
      }
