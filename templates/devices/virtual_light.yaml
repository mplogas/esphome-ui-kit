# templates/devices/virtual_light.yaml
platform: homeassistant
entity_id: ${hass_entity_id}
id: ${id}_state
internal: true
on_value:
  - if:
      condition:
        lambda: 'return !id(user_is_interacting);'
      then:
        - lambda: |-
            lv_color_t color;
            lv_color_t bg_color;

            if (x == "on") {
              // Default "On" colors
              color = lv_color_hex(0xEF8513); // Default Orange
              bg_color = lv_color_hex(0x303030);

              // Try to parse RGB from the companion sensor
              std::string rgb_str = id(${id}_rgb).state;
              int r, g, b;
              // HA sends tuple like "(255, 100, 50)" or list "[255, 100, 50]"
              // We scan for 3 integers ignoring other chars
              if (sscanf(rgb_str.c_str(), "(%d,%d,%d)", &r, &g, &b) == 3 || 
                  sscanf(rgb_str.c_str(), "[%d,%d,%d]", &r, &g, &b) == 3 ||
                  sscanf(rgb_str.c_str(), "%d,%d,%d", &r, &g, &b) == 3) {
                  
                  color = lv_color_make(r, g, b);
                  // Make background a very dark version of the color
                  bg_color = lv_color_make(r/5, g/5, b/5);
              }
            } else {
              // Off State
              color = lv_color_hex(0xAAAAAA);
              bg_color = lv_color_hex(0x202020);
            }
            
            // Use LVGL C API to set styles
            if (id(${widget_id}_icon) != nullptr) {
              lv_obj_set_style_text_color(id(${widget_id}_icon), color, LV_PART_MAIN);
            }
            if (id(${widget_id}) != nullptr) {
              lv_obj_set_style_bg_color(id(${widget_id}), bg_color, LV_PART_MAIN);
            }
